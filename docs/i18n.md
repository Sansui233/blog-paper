# Internationalization (i18n) 方案

本文档描述博客的国际化实现方案，包括语言切换和日期处理。

## 技术栈

- **i18next** + **react-i18next**: 翻译框架
- **Zustand**: 语言状态管理
- **localStorage**: 语言偏好持久化

## 语言支持

| 语言 | 代码 | 翻译文件 |
|------|------|----------|
| 中文 | `zh` | `locales/zh.json` |
| English | `en` | `locales/en.json` |
| 日本語 | `ja` | `locales/ja.json` |

## 初始化流程

```
页面加载
    ↓
检查 navigator.language
    ↓
┌─ 有值 → 使用存储的语言
└─ 无值 → 检测 localStorage('language')
              ↓
         匹配支持的语言？
         ├─ 是 → 使用浏览器语言
         └─ 否 → 使用默认语言 'zh'
    ↓
初始化 i18next
    ↓
渲染页面
```

## 文件结构

```
lib/
├── i18n.ts           # i18next 初始化配置
└── date.ts           # 日期处理函数

locales/
├── zh.json           # 中文翻译
├── en.json           # 英文翻译
└── ja.json           # 日文翻译

app/compoentns/common
└── I18nProvider.ts   # 给 root.tsx 设置全局FCP后的语言替换。
```

## 使用方式

### 组件中使用翻译

```tsx
import { useTranslation } from 'react-i18next';

function MyComponent() {
  const { t } = useTranslation();
  return <span>{t('ui.posts')}</span>;
}
```

### 切换语言

```tsx
import useAppState from '~/hooks/use-appstate';

function LanguageSwitcher() {
  const { i18next } = useAppState();
  i18next.changeLanguage()
}
```

---

# 日期处理方案

## 核心设计

**数据来源:** 所有日期字符串存储为东八区时间（无时区标识），如 `"2026-01-06 03:04"`

**配置:** 在 `site.config.ts` 中通过 `timeZone` 字段标识数据的默认时区

```typescript
export const siteInfo: SiteInfo = {
  // ...
  timeZone: 'Asia/Shanghai', // 数据存储的默认时区
}
```

## 日期函数 (`lib/date.ts`)

| 函数 | 用途 | 输入 | 输出示例 |
|------|------|------|----------|
| `parseDate(str)` | 解析日期字符串为 Date | `string \| Date` | `Date` 对象 |
| `dateI18n(d, mode)` | 国际化日期显示 | `Date`, `'dateNatural' \| 'dateYMD'` | "Jan 6th, 2026" / "1月6日" |
| `dateToYMDHM(d)` | 固定格式时间戳 | `Date` | "2026-01-06 03:04" |
| `dateRelative(d)` | 相对时间 | `Date` | "5分钟前" / "5 min ago" |
| `parseMemoId(id)` | Memo ID 解析 | `string` | `{ date: Date, display: string }` 或 `{ date: null, display: id }` |

## Memo ID 特殊处理

Memo ID 可能是时间格式（如 `"2026-01-06 03:04"`），也可能是普通字符串。解析失败时直接使用 ID 本身渲染：

```typescript
export function parseMemoId(id: string): { date: Date | null; display: string } {
  const parsed = parseDate(id);
  if (parsed.getTime() === -1) {
    // 解析失败，直接使用 ID 本身
    return { date: null, display: id };
  }
  return { date: parsed, display: dateRelative(parsed) };
}
```

## 时区处理流程

```
┌─────────────────────────────────────────────────────────────┐
│  数据存储 (东八区字符串)                                      │
│  "2026-01-06 03:04"                                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  parseDate() - 客户端解析                                    │
│  1. 检测字符串是否带时区                                      │
│  2. 若无时区，附加 siteInfo.timeZone 偏移                    │
│  3. 返回 Date 对象（内部为 UTC）                              │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  显示函数 - 自动转换为用户本地时区                            │
│  dateI18n() / dateRelative() / dateToYMDHM()                │
│  使用 Intl.DateTimeFormat 或 Date 方法自动本地化             │
└─────────────────────────────────────────────────────────────┘
```

## 使用场景

| 页面 | 组件 | 使用函数 |
|------|------|----------|
| Home | ArticleItem | `dateI18n(d, 'dateNatural')` |
| Post | PostMeta | `dateI18n(d, 'dateNatural')` |
| Memo | MemoCard 时间 | `parseMemoId(id)` → 成功用 `dateRelative()`，失败用 ID 原文 |
| Memo | 详细时间戳 | `dateToYMDHM(d)` |

## 翻译 Key

日期相关的翻译 key 位于 `locales/*.json` 的 `ui` 命名空间下：

```json
{
  "ui": {
    "dateNatural": "{{month}} {{day}}{{daySuffix}}, {{year}}",
    "dateYMD": "{{year}}-{{month}}-{{day}}",
    "dateYMDHM": "{{year}}-{{month}}-{{day}} {{hour}}:{{minute}}",
    "timeJustNow": "just now",
    "timeMinutesAgo": "{{count}} min ago",
    "timeHoursAgo": "{{count}} hr ago",
    "timeDaysAgo": "{{count}} days ago"
  }
}
```

### 各语言格式

| Key | zh | en | ja |
|-----|----|----|-----|
| `dateNatural` | `{{year}}年{{month}}月{{day}}日` | `{{month}} {{day}}{{daySuffix}}, {{year}}` | `{{year}}年{{month}}月{{day}}日` |
| `timeJustNow` | 刚刚 | just now | たった今 |
| `timeMinutesAgo` | {{count}}分钟前 | {{count}} min ago | {{count}}分前 |
| `timeHoursAgo` | {{count}}小时前 | {{count}} hr ago | {{count}}時間前 |
| `timeDaysAgo` | {{count}}天前 | {{count}} days ago | {{count}}日前 |
