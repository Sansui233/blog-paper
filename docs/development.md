## 开发环境

**编辑器：Vscode**

- prettier 插件
- tailwind 插件和项目配置（.vscode/settings.json）

```json
{
  "files.associations": {
    "*.css": "tailwindcss"
  }
}
```
- tailwind fold 插件

**书写工具**

- Obsidian：有模板，quick add 插件绑到 Dataview 页面的按钮上，有相当于 Notion 的模板体验
- Typora：Memo专用，很有吐槽欲望）

**包管理器：pnpm**

## 概览

可以见 CLAUDE.md 的分析

**路由**
如果你完全没有了解过 react-router 7，建议先了解 `routes.ts` 中的路由写法，以明白是页面的布局更新与路由是什么关系。

**主要组件**

- Home 页面，分类栏，搜索
- Post 页面：正文，翻页，边栏（目录），评论。Img
- Memo 页面：
  - 虚拟列表，边栏，评论 Modal
  - Img 浏览器（各种比例的图片支持）
  - 客户端搜索与路由跳转
- About 页面
- 标签和分类页面，其中 All Post，相当于以前的 Archive。时间线布局说实话比主页好看，但不太像主页，好看归好看，信息少了其实不太好。

##  Markdown 构建与搜索

这次解析 markdown 的策略是能预构建就预构建，在构建速度上和渲染速度上都会有一些提升。但有个问题是网站需要站内本地搜索，搜索需要拿到原始的字符串而不是去搜索JSX，如果搜索和渲染分开构建，就会使客户端同时请求两份文件。为了减少网络传输体积，对于长文和memo采用了不同的策略。

对于长文，搜索后是直接跳转网页而不是请求原始文件，因此直接使用了去除HTML标签的RSS文件作为搜索索引，而且恰好所有的长文都是会被velite 解析为 RSS 的。

Memo 的情况就不一样了，和渲染数据都是从客户端请求的，为了避免最影响体验的网络延迟，请求次数越少越好，相应的单次请求体积就会增大。而 Memo 索引数据数据量大很多，其实我只给memo做了目前数据量 1/3 的索引，原始 markdown 打包前体积已经来到了近300K（太能水了）。对于搜索引擎匹配功能我会写在 Readme 写详细说明。

鉴于实在是太能水memo了，还是保持了原来的设计，选择了首页使用预构建的JS X数据，而后续请求列表时同时下载那个50kb的MDX JS代码库做客户端渲染。

## 分页

现代肯定不设计分页的，不分页最大的问题是性能，如果做虚拟滚动就会 SEO 不友好。分页的最大问题是交互太傻了。不过还是那句……就这数据量，有什么必要分页啊？像 memo 页面因为吐槽很多，所以前期就会做虚拟列表的，而且老实说，我并不想 memo 被搜索引擎搜到。
不过，我已经想好了，要真的有上千条到会卡的地步，就分页。这也是我换 react-router 的原因，用那一套，真的渲染所有分页，但是看起来像没分的 csr，从不同页面进去看起来只是像处在页面的不同位置罢了。

不过要卡真的很难，我刚写的字体管理器一千多个字体的渲染，启动时都是两秒加载的，这还包括 rust 后台从磁盘读数据和分析的时间。也就是resize window reflow 会卡一秒。谁开个网页 resize window 玩？

## 图片处理

所有图片都不知道宽高和大小，因此不适合做一页超多的图片显示。但 memo 相册还是要考虑做，大概一批图片请求后瞬间排版。打算瀑布流。

上传图片到图床时注意要优化大小。

虽然 velite 可以处理 assets，好处是本地的图可以有缩略图，反正图片本地和云端都得选一个地方放，我觉得自己提前上传比较好。但是 Memo 的相册我可能会考虑一下用本地的图。

## 虚拟列表

VirtualList 为单向增长的虚拟列表（其实可以支持双向但是 Height 数组和 Indices 要重新映射）。并且注意派生状态的坑。要么数据全部自己接管为State，要么全部由父级直接控制，而且千万不要在把父级 State 和父级 Props 混合传入，特别是父级有 useEffect 时，容易造成反模式有潜在的 Bug。Debug 过一次就老实了。

## 搜索

搜索为自实现的超小逐字匹配，搜索引擎，支持字段搜索。比如`tags: xxx` 搜索标签字段。对于个人而言完全够了

当时还留了个打断搜索的接口，现在觉得完全没有必要……就这数据量，有什么必要啊？前期不要过度设计。

## 打算

- Memo 会增加功能，但不一定会接入推特啥的，为什么？因为如果服务端渲染会显著增加 build 的时长，如果客户端渲染，可能会被墙。B 站会考虑一下。
- 几年前头铁想搞金色主题，但金色在没有材质时等于屎黄色，效果不如高饱和印象色。算了……就这样吧。
- SSG 的动画有限制，我一直想给顶栏加动画，但 Next.js 之前是不行的，因为完全分割掉了。现在 rr 似乎可以用 Outlet
